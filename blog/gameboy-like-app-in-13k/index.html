<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>How I created a GameBoy-like game in 13kb</title>
		<meta name="description" content="History of Gravepassing - my entry for js13kgames 2022.">
		<link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Hypersphere">
		<link rel="alternate" href="/feed/feed.json" type="application/json" title="Hypersphere">

		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Condensed:wght@700&family=IBM+Plex+Sans:ital,wght@0,200;0,400;0,700;1,200;1,400&display=swap" rel="stylesheet">

		<meta property="og:title" content="How I created a GameBoy-like game in 13kb"/>
		<meta property="og:url" content="https://hypersphere.blog/blog/gameboy-like-app-in-13k/" />
		<meta property="og:description" content="History of Gravepassing - my entry for js13kgames 2022." />
		<meta property="og:image" content="/default-cover.jpg" />
		<meta property="og:type" content="article" />

		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@kulak_at" />
		<meta name="twitter:creator" content="@kulak_at" />
		
		<style>/**
 * okaidia theme for JavaScript, CSS and HTML
 * Loosely based on Monokai textmate theme by http://www.monokai.nl/
 * @author ocodia
 */

code[class*="language-"],
pre[class*="language-"] {
	color: #f8f8f2;
	background: none;
	text-shadow: 0 1px rgba(0, 0, 0, 0.3);
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	font-size: 1em;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
	border-radius: 0.3em;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #272822;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: #8292a2;
}

.token.punctuation {
	color: #f8f8f2;
}

.token.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.constant,
.token.symbol,
.token.deleted {
	color: #f92672;
}

.token.boolean,
.token.number {
	color: #ae81ff;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #a6e22e;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string,
.token.variable {
	color: #f8f8f2;
}

.token.atrule,
.token.attr-value,
.token.function,
.token.class-name {
	color: #e6db74;
}

.token.keyword {
	color: #66d9ef;
}

.token.regex,
.token.important {
	color: #fd971f;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
/*
 * New diff- syntax
 */

pre[class*="language-diff-"] {
	--eleventy-code-padding: 1.25em;
	padding-left: var(--eleventy-code-padding);
	padding-right: var(--eleventy-code-padding);
}
.token.deleted {
	background-color: hsl(0, 51%, 37%);
	color: inherit;
}
.token.inserted {
	background-color: hsl(126, 31%, 39%);
	color: inherit;
}

/* Make the + and - characters unselectable for copy/paste */
.token.prefix.unchanged,
.token.prefix.inserted,
.token.prefix.deleted {
	-webkit-user-select: none;
	user-select: none;
	display: inline-flex;
	align-items: center;
	justify-content: center;
	padding-top: 2px;
	padding-bottom: 2px;
}
.token.prefix.inserted,
.token.prefix.deleted {
	width: var(--eleventy-code-padding);
	background-color: rgba(0,0,0,.2);
}

/* Optional: full-width background color */
.token.inserted:not(.prefix),
.token.deleted:not(.prefix) {
	display: block;
	margin-left: calc(-1 * var(--eleventy-code-padding));
	margin-right: calc(-1 * var(--eleventy-code-padding));
	text-decoration: none; /* override del, ins, mark defaults */
	color: inherit; /* override del, ins, mark defaults */
}
* { box-sizing: border-box; }
/* Defaults */
:root {
	--font-family: 'IBM Plex Sans', sans-serif;
	--font-family-monospace: Consolas, Menlo, Monaco, Andale Mono WT, Andale Mono, Lucida Console, Lucida Sans Typewriter, DejaVu Sans Mono, Bitstream Vera Sans Mono, Liberation Mono, Nimbus Mono L, Courier New, Courier, monospace;
}

/* Theme colors */
:root {
	--color-gray-20: #e0e0e0;
	--color-gray-50: #C0C0C0;
	--color-gray-90: #333;

	--background-color: #fff;

	--text-color: var(--color-gray-90);
	--text-color-link: inherit;
	--text-color-link-active: inherit;
	--text-color-link-visited: inherit;

	--syntax-tab-size: 2;

	--color-badge: rgb(31, 139, 202);
	--color-badge-hover: rgb(6, 57, 87);

	--color-header: #F00;
}

@media (prefers-color-scheme: dark) {
	:root {
		--color-gray-20: #e0e0e0;
		--color-gray-50: #C0C0C0;
		--color-gray-90: #dad8d8;

		/* --text-color is assigned to --color-gray-_ above */
		/* --text-color-link: #1493fb;
		--text-color-link-active: #6969f7;
		--text-color-link-visited: #a6a6f8; */


		--text-color-link: inherit;
		--text-color-link-active: inherit;
		--text-color-link-visited: inherit;

		--background-color: #15202b;
	}
}


/* Global stylesheet */
* {
	box-sizing: border-box;
}

html,
body {
	padding: 0;
	margin: 0 auto;
	font-family: var(--font-family);
	font-size: 16px;
	color: var(--text-color);
	background-color: var(--background-color);
}
html {
	overflow-y: scroll;
}
/* body {
	max-width: 60em;
} */

.grid-wrapper {
	--gap: 1em;
	display: grid;
	grid-template-columns: 1fr min(80ch, calc(100% - 2 * var(--gap))) 1fr;
	column-gap: var(--gap);
	font-size: clamp(14px, 1vw, 36px);
}

.grid-wrapper > * {
	grid-column: 2;
}

.full-bleed {
	width: 100%;
	grid-column: 1 / -1;
}

h1, h2, h3, h4 {
	font-family: 'IBM Plex Sans Condensed', sans-serif;
	font-weight: 700;
}

/* https://www.a11yproject.com/posts/how-to-hide-content/ */
.visually-hidden {
	clip: rect(0 0 0 0);
	clip-path: inset(50%);
	height: 1px;
	overflow: hidden;
	position: absolute;
	white-space: nowrap;
	width: 1px;
}

p:last-child {
	margin-bottom: 0;
}
p {
	line-height: 1.5;
}

li {
	line-height: 1.5;
}

a[href] {
	color: var(--text-color-link);
}
a[href]:visited {
	color: var(--text-color-link-visited);
}
a[href]:hover,
a[href]:active {
	color: var(--text-color-link-active);
}

header {
	border-bottom: 1px solid var(--color-gray-20);
}
header:after {
	content: "";
	display: table;
	clear: both;
}

.links-nextprev {
	list-style: none;
	border-top: 1px dashed var(--color-gray-20);
	padding: 1em 0;
}

table {
	margin: 1em 0;
}
table td,
table th {
	padding-right: 1em;
}

pre,
code {
	font-family: var(--font-family-monospace);
}
pre:not([class*="language-"]) {
	margin: .5em 0;
	line-height: 1.375; /* 22px /16 */
	-moz-tab-size: var(--syntax-tab-size);
	-o-tab-size: var(--syntax-tab-size);
	tab-size: var(--syntax-tab-size);
	-webkit-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
	direction: ltr;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
}
code {
	word-break: break-all;
}

/* Header */
header {
	display: flex;
	gap: 1em .5em;
	flex-wrap: wrap;
	align-items: center;
	padding: 1em;
}
.home-link {
	font-size: 1.2em;
	font-weight: 700;
	margin-right: 2em;
}
.home-link:link:not(:hover) {
	text-decoration: none;
}

/* Nav */
.nav {
	display: flex;
	padding: 0;
	margin: 0;
	list-style: none;
}
.nav-item {
	display: inline-block;
	margin-right: 1em;
}
.nav-item a[href]:not(:hover) {
	text-decoration: none;
}
.nav a[href][aria-current="page"] {
	text-decoration: underline;
}

/* Posts list */
.postlist {
	list-style: none;
	padding: 0;
}
.postlist-item {
	align-items: baseline;
	margin-bottom: 1em;
}
.postlist-date,
.postlist-item:before {
	font-size: 0.8125em; /* 13px /16 */
	color: var(--color-gray-90);
}
.postlist-date {
	word-spacing: -0.5px;
}
.postlist-link {
	font-size: 1.1875em; /* 19px /16 */
	font-weight: 700;
	flex-basis: calc(100% - 1.5rem);
}
.postlist-item-active .postlist-link {
	font-weight: bold;
}

.postlist-link {
	gap: 20px;
	text-decoration: none;
	display: inline-block;
	display: flex;
}

.postlist-link p {
	font-weight: normal;
}

.postlist-link:hover {
	background: rgba(0,0,0,0.2);
}

.post-image {
	flex: 1;
	font-size: 0;
}

.post-image img {
	aspect-ratio: 1 !important;
	object-fit: cover;
	width: 100%;
	/* height: 100%; */
}

.post-description {
	flex: 2;
	display: flex;
	flex-direction: column;
	padding-right: 1em;
}

.post-description time {
	border-bottom: 1px solid rgba(255,255,255,0.1);
}

.post-description h2 {
	line-height: 1;
}

/* .post-description p {
	margin-top: auto;
} */

/* Tags */
.post-tag {
	display: inline-flex;
	align-items: center;
	justify-content: center;
	text-transform: capitalize;
	background: var(--color-badge);
	text-decoration: none;
	font-size: 0.8em;
	padding: 8px;
	border-radius: 8px;
	font-weight: 700;
	font-family: 'IBM Plex Sans Condensed', sans-serif;
	text-transform: uppercase;
}

.post-tag:hover {
	background: var(--color-badge-hover);
}

.postlist-item > .post-tag {
	align-self: center;
}

/* Tags list */
.post-metadata {
	display: inline-flex;
	flex-wrap: wrap;
	gap: .5em;
	list-style: none;
	padding: 0;
	margin: 0;
	align-items: center;
	align-content: center;
}

.article a {
	color: var(--text-color);
}

.article {
	font-size: 20px;
	line-height: 1.5em;
}

.article pre {
	font-size: 14px;
}

.article-headings {
	--offset: calc(min(10vh, 50px));
	/* background: #0a0f15; */
	padding: 48px 0 20px 0;
	position: relative;
	border-bottom: 1px solid var(--color-gray-50);
	/* transform: translate(0, calc(-1 * var(--offset))); */
	/* margin-bottom: calc(-1 * var(--offset)); */
}

.article-headings h1 {
	font-size: 2em;
	line-height: 1.4em;
	margin-bottom: 0;
}

.article-headings h2 {
	margin: 0.2em 0 0.5em 0;
}

.article-time {
	display: block;
	margin: 0.5em 0;
}

/* Direct Links / Markdown Headers */
.header-anchor {
	text-decoration: none;
	font-style: normal;
	font-size: 1em;
	margin-left: .1em;
}
a[href].header-anchor,
a[href].header-anchor:visited {
	color: transparent;
}
a[href].header-anchor:focus,
a[href].header-anchor:hover {
	text-decoration: underline;
}
a[href].header-anchor:focus,
:hover > a[href].header-anchor {
	color: #aaa;
}

h2 + .header-anchor {
	font-size: 1.5em;
}

main img {
	max-width: 100%;
	height: auto;
	margin: 0 auto;
	display: block;
}


.article-link {
	padding: 1em;
	margin: 0 2em;
	border: 1px solid var(--color-gray-90);
	display: block;
	display: flex;
	background: var(--color-gray-20);
	text-decoration: none;
	color: #000;
	justify-items: space-between;
}

.article-link:hover {
	background:rgb(184, 212, 228);
}

.article-link img {
	width: 30%;
	margin-right: 2em;
	margin-left: 0;
}

.article-link div {
	color: #000;
	text-decoration: none;
}

.article-link .details {
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.article-link .details p {
	font-size: 0.8em;
}

.article-link .link-title {
	font-size: 1.1em;
	font-weight: 800 !important;
}

.article-link .link-url {
	font-size: 0.4em;
	line-height: 1em;
	margin-top: auto;
}



.postlist-grid {
	display: grid;
	grid-template-columns: 1fr 1fr 1fr 1fr;
	gap: 16px;
	padding: 1em;
	margin: 0 auto;
	max-width: 300ch;
}

.postlist-item:first-child {
	grid-column: 1 / 3;
}

@media (max-width: 700px) {
	.postlist-grid {
		grid-template-columns: 1fr;
	}

	.postlist-item:first-child {
		grid-column: auto;
	}
}

@media (max-width: 1000px) and (min-width: 701px) {
	.postlist-grid {
		grid-template-columns: 1fr 1fr;
	}
}

@media (max-width: 1600px) and (min-width: 1001px) {
	.postlist-grid {
		grid-template-columns: 1fr 1fr 1fr;
	}
}


/* .postlist-item {
	background: rgb(0,0,0,0.1)
} */

.postlist-item a {
	height: 100%;
	background: rgb(0,0,0,0.1);
	width: 100%;
}

/* .postlist-item:nth-child(2) { */
	/* grid-row: 1 / -1; */
/* } */</style>
	</head>
	<body>
		<a href="#skip" class="visually-hidden">Skip to main content</a>

		<header>
			<a href="/" class="home-link">Hypersphere</a>
			<nav>
				<h2 class="visually-hidden">Top level navigation menu</h2>
				<ul class="nav">
					<li class="nav-item"><a href="/">About Me</a></li>
					<li class="nav-item"><a href="/blog/">Archive</a></li>
				</ul>
			</nav>
		</header>

		<main id="skip">
			

<section class="article grid-wrapper">

<div class="cover full-bleed">
	<img alt="Article Cover" loading="lazy" decoding="async" style="aspect-ratio: 1.694915254237288" width="2000" height="1180" src="/img/TwPZntxLeN-2000.webp">
</div>
<div class="article-headings">
	<h1>How I created a GameBoy-like game in 13kb</h1><h2>History of Gravepassing ‚Äî my entry for js13kgames 2022.</h2>
	<time class="article-time" datetime="2022-10-10">10 October 2022</time>
	<ul class="post-metadata">
	<li><a href="/tags/web-game-development/" class="post-tag">Web Game Development</a> </li>
	<li><a href="/tags/typescript/" class="post-tag">TypeScript</a> </li>
	<li><a href="/tags/javascript/" class="post-tag">JavaScript</a> </li>
	<li><a href="/tags/canvas/" class="post-tag">Canvas</a> </li>
	<li><a href="/tags/js13k/" class="post-tag">JS13K</a></li>
</ul>
</div>

<!-- <img alt="Article Cover" loading="lazy" decoding="async" style="aspect-ratio: 1.694915254237288" width="2000" height="1180" src="/img/TwPZntxLeN-2000.webp"> -->
<p>This year I decided to participate in the js13kgames game jam. It‚Äôs a yearly, month-long competition to create a game in JavaScript from scratch that will fit 13kb (zipped). It does not sound like plenty of space, but with enough creativity, a lot can be achieved. Just look at those amazing examples from the past years:</p>
<ul>
<li><a href="https://js13kgames.com/entries/underrun">Underrun</a> (winner in 2018)</li>
<li><a href="https://js13kgames.com/entries/ninja-vs-evilcorp">Ninja vs Evil-corp</a> (winner in 2020)</li>
<li><a href="https://js13kgames.com/entries/beat-rocks">Beat Rocks</a> (2nd place in 2021)</li>
</ul>
<p>Even though my game did not rank high this year, I still want to share some discoveries I‚Äôve made along my journey.</p>
<p>For this year‚Äôs entry, I decided to create a game that evokes the retro era of handheld games, with its unique square form factor, low resolution, and top-down graphics. For the gameplay, I‚Äôve wanted it to be a fast-paced action-RPG style, with easy but addictive gameplay that encourages you to continue playing. The music choice was obvious ‚Äî sound effects must feel like taken directly from the arcades.</p>
<p>If you want to play the game, you can do it on <a href="https://js13kgames.com/entries/gravepassing">the Gravepassing JS13KGames entry page</a>. The full code is <a href="https://github.com/h-sphere/gravepassing">available on GitHub</a>.</p>
<p>In this article I would like to describe my journey and the different components and challenges I faced along the way:</p>
<ul>
<li>Inspirations</li>
<li>Drawing graphics using emojis</li>
<li>Dithering effect</li>
<li>Object storage using Quad Tree</li>
<li>Music</li>
<li>Compression</li>
</ul>
<h2 id="inspirations-and-graphics" tabindex="-1">Inspirations and graphics <a class="header-anchor" href="#inspirations-and-graphics">#</a></h2>
<p>The choice for the graphics was a mix of the 1990s style handheld and home consoles like GameBoy Color and NES games. It wasn‚Äôt meant to mimic any specific game or style, but rather to be reminiscent of the era.</p>
<img alt="Inspirations" loading="lazy" decoding="async" style="aspect-ratio: 1.2260869565217392" width="2115" height="1725" src="/img/PD2D3sRs6s-2115.webp">
<p>I decided to go with 16x16px tiles making up one game unit. Each time on the screen you can see a 10x10 grid which results in a resolution of 160x160px (integer upscaled to look good on modern displays). This results in a more-or-less GameBoy feel, although the original hardware used 8x8px tiles instead and 160√ó144px resolution in total.</p>
<p>As for the graphics, due to the size limitation, I restrained from adding any sprite maps. Instead, I use downscaled emojis to combine the sprites.</p>
<img alt="Regular emojis rendered in very small sizes can get completely new meanings." loading="lazy" decoding="async" style="aspect-ratio: 1" width="792" height="792" src="/img/HEcdLvu56b-792.webp">
<p>The image above shows how the player model was built. It uses 4 emojis. Unsurprisingly I used a head emoji for a head with glasses on top, and trousers for a bottom part of a sprite. The torso part is a <a href="https://en.wikipedia.org/wiki/Red_envelope">Red Envelope</a> though, a popular monetary gift in Southeast Asia. Drawn in this resolution it loses all the details and the elongated shape of it is perfect to simulate the body.</p>
<p>Emojis are not unified across the operating systems, which leads to the interesting effect of game rendering completely different on each OS. You can see the differences in the image below:</p>
<img alt="Different operating systems: Windows, Ubuntu, MacOS" loading="lazy" decoding="async" style="aspect-ratio: 2.0350132625994695" width="3836" height="1885" src="/img/fwkFVCEbYB-3836.webp">
<p>Moreover, not all the systems support the same version of Unicode, making some of the newer emojis not compatible with older systems. In the screenshot above you can see that the tombstone emoji (ü™¶) was replaced with a coffin (‚ö∞Ô∏è) on Windows and Ubuntu ‚Äî <a href="https://emojipedia.org/headstone/">tombstone was introduced in Unicode 13.0</a>. To achieve it I have created a small script rendering each emoji and checking if it was rendered properly. If not, it‚Äôs replaced with its equivalent specified in the handwritten configuration. Because emojis on different systems might have different sizes, some fine-tuning was required too.</p>
<pre class="language-ts" tabindex="0"><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">OptionalEmojiSet</span> <span class="token punctuation">{</span>
    <span class="token comment">// EMOJI</span>
    e<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    <span class="token comment">// POS</span>
    pos<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// SIZE</span>
    size<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> alt<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> OptionalEmojiSet<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"ü™¶"</span><span class="token operator">:</span> <span class="token punctuation">{</span> e<span class="token operator">:</span> <span class="token string">"‚ö∞Ô∏è"</span><span class="token punctuation">,</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token operator">:</span> <span class="token number">.9</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"‚õì"</span><span class="token operator">:</span> <span class="token punctuation">{</span> e<span class="token operator">:</span> <span class="token string">"üëñ"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"ü™®"</span><span class="token operator">:</span> <span class="token punctuation">{</span> e<span class="token operator">:</span> <span class="token string">"üíÄ"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"ü™µ"</span><span class="token operator">:</span> <span class="token punctuation">{</span> e<span class="token operator">:</span> <span class="token string">"üå≥"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"ü¶¥"</span><span class="token operator">:</span> <span class="token punctuation">{</span> e<span class="token operator">:</span> <span class="token string">"üíÄ"</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">export</span> <span class="token keyword">const</span> win<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> OptionalEmojiSet<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"üî•"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"üí£"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"üë±"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"üï∂"</span><span class="token operator">:</span> <span class="token punctuation">{</span> size<span class="token operator">:</span> <span class="token number">1.5</span><span class="token punctuation">,</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"‚¨õÔ∏è"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"üëñ"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"üê∑"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"ü¶ã"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"üêÆ"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"üëî"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"üë©"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"ü§ñ"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"üëö"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"üêµ"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"‚ò¢Ô∏è"</span><span class="token operator">:</span>  <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"üëπ"</span><span class="token operator">:</span> <span class="token punctuation">{</span> pos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> tux<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> OptionalEmojiSet<span class="token operator">></span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string-property property">"üßß"</span><span class="token operator">:</span> <span class="token punctuation">{</span> e<span class="token operator">:</span> <span class="token string">"üëî"</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>To check when each of the emojis was introduced, <a href="https://www.unicode.org/emoji/charts/emoji-versions.html">the following table was a really handy resource</a>.</p>
<h2 id="game-screen-structure" tabindex="-1">Game Screen Structure <a class="header-anchor" href="#game-screen-structure">#</a></h2>
<p>The screen displays 10x10 grid of 16px x 16px tiles making total of 160x160px resolution. Obviously, displaying it directly in such resolution would result in a tiny square on our modern 4k screens ‚Äî that‚Äôs why the image is integer upscaled to the maximum value possible.</p>
<img alt="Game Screen Structure." loading="lazy" decoding="async" style="aspect-ratio: 1.6164987405541562" width="2567" height="1588" src="/img/3cdrX0sTmY-2567.webp">
<p>To downscale emojis, I used a separate, tiny canvas that kept individual spites rendered in its original 16x16px. Then I can use those sprites to render them to the big destination canvas whenever needed. This allowed me to generate temporary sprite sheets to check if the tiles were properly generated.</p>
<p>By default, canvas uses image smoothing meaning that when the sprite gets upscaled, it will be smoothened using antialiasing. To avoid that, we need to turn it off.</p>
<pre class="language-ts" tabindex="0"><code class="language-ts">context<span class="token punctuation">.</span>imageSmoothingEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></code></pre>
<h3 id="canvas-optimisation" tabindex="-1">Canvas Optimisation <a class="header-anchor" href="#canvas-optimisation">#</a></h3>
<p>One of the weird optimization techniques I came across was generating a bitmap from the canvas without saving it. I suspect this marks that portion of the canvas as not changed for future uses and can optimize rendering, but I could not find any definite answer what‚Äôs the exact mechanism that‚Äôs causing it. If you know the answer, please share it in the comments!</p>
<pre class="language-ts" tabindex="0"><code class="language-ts"><span class="token function">createImageBitmap</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">getImageData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>width<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>canvas<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// This makes consecutive rendering faster</span></code></pre>
<h2 id="quadtree" tabindex="-1">QuadTree <a class="header-anchor" href="#quadtree">#</a></h2>
<p>During the game lifecycle, a lot of game objects appear and disappear from the screen. The majority of the game logic revolves around finding which objects are close to each other and detecting collisions or proximity of them ‚Äî every interaction like movement, detecting collisions, enemies following the player, etc; includes logic for finding objects within some distance. The most naive solution for this problem would be to check all objects stored in the memory. Unfortunately, this requires a lot of comparisons. If we would like to perform this action for each of the elements, this would result in having to do O(n¬≤) comparisons every frame.</p>
<p>With QuadTree, we can do a precomputation to optimize this process. The tree stores our elements in its nodes until the node reaches its capacity. In this scenario, it divides the space into four subspaces (thus the quad in the name). Then, each time we want to find all elements within the given area, we can easily discard objects outside the boundary. The whole process is recursive, so you end up with a structure that is really fast to find elements in.</p>
<img alt="Visual representation of a quad-tree. The space gets divided into four subsections if there are too many items within its boundaries. Green rectangles represent the boundaries of the game objects." loading="lazy" decoding="async" style="aspect-ratio: 1.092896174863388" width="1200" height="1098" src="/img/cG8yr5Ofk9-1200.webp">
<p>The recursive implementation itself is not too long and can easily fit within 100 lines.</p>
<pre class="language-ts" tabindex="0"><code class="language-ts"><span class="token keyword">import</span> <span class="token punctuation">{</span> GameObject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../modules/GameObjects/GameObject"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Rectangle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../modules/Primitives"</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">QuadTree</span> <span class="token punctuation">{</span>
    objects<span class="token operator">:</span> Set<span class="token operator">&lt;</span>GameObject<span class="token operator">></span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    subtrees<span class="token operator">:</span> QuadTree<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> _boundary<span class="token operator">:</span> Rectangle<span class="token punctuation">,</span> <span class="token keyword">private</span> limit<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">get</span> <span class="token function">boundary</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_boundary<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">get</span> <span class="token function">subTrees</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subtrees<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token function">subdivide</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> p1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>boundary<span class="token punctuation">.</span>p1<span class="token punctuation">;</span>
        <span class="token keyword">const</span> mid <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>boundary<span class="token punctuation">.</span>center<span class="token punctuation">;</span>
        <span class="token keyword">const</span> w <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>boundary<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
        <span class="token keyword">const</span> h <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>boundary<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>subtrees <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token keyword">new</span> <span class="token class-name">QuadTree</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> mid<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>limit<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">QuadTree</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mid<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>limit<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">QuadTree</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mid<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> h<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>limit<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">QuadTree</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Rectangle</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> h<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mid<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> h<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>limit<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token comment">// we need to add all exisitng points now</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>o <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>subtrees<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>t <span class="token operator">=></span>
                t<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> GameObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>boundary<span class="token punctuation">.</span><span class="token function">isIntersectingRectangle</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getBoundingBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>objects<span class="token punctuation">.</span>size <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>limit <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>boundary<span class="token punctuation">.</span>width <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>boundary<span class="token punctuation">.</span>height <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>subtrees<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">subdivide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>subtrees<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>t <span class="token operator">=></span> <span class="token punctuation">{</span>
               t<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">getInArea</span><span class="token punctuation">(</span>boundary<span class="token operator">:</span> Rectangle<span class="token punctuation">)</span><span class="token operator">:</span> Set<span class="token operator">&lt;</span>GameObject<span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>boundary<span class="token punctuation">.</span><span class="token function">isIntersectingRectangle</span><span class="token punctuation">(</span>boundary<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>subtrees<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> s <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span>GameObject<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> tree <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subTrees<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tree<span class="token punctuation">.</span><span class="token function">getInArea</span><span class="token punctuation">(</span>boundary<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>obj <span class="token operator">=></span> s<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> s<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> points <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span>GameObject<span class="token operator">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>obj <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>boundary<span class="token punctuation">.</span><span class="token function">isIntersectingRectangle</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">getBoundingBox</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                points<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> points<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="dithering-effect" tabindex="-1">Dithering Effect <a class="header-anchor" href="#dithering-effect">#</a></h2>
<img alt="Dithering effect." loading="lazy" decoding="async" style="aspect-ratio: 2.1226666666666665" width="2388" height="1125" src="/img/PUyIudwzQM-2388.webp">
<p>To achieve retro aesthetics instead of varying the opacity of shadows, I resorted to dithering.</p>
<p>The dithering effect is a technique of mimicking a richer color palette by alternating colors from the smaller set. In the picture above each of the patterns seems to be increasing in brightness even though all of them use just 2 base colors ‚Äî black and purple.</p>
<p>The effect was commonly used in old consoles and early computer games and applications where the palette was limited. This made developers think outside the box and use techniques like dithering to fake our eyes into thinking there are more colors than actually were displayed on the screen. And maybe most notably GameBoy Camera used ordered dither to display any image captured with it.</p>
<p>I plan to write a separate article about the effect and some use cases but before that, you can check the code for the effect in the following CodePen:</p>
<p class="codepen" data-height="300" data-default-tab="result" data-slug-hash="OJZJZxY" data-user="hypersphere" style="height: 800px; box-sizing: border-box; display: flex; align-items: center; justify-content: center; border: 2px solid; margin: 1em 0; padding: 1em;">
  <span>See the Pen <a href="https://codepen.io/hypersphere/pen/OJZJZxY">
  Dither</a> by hypersphere (<a href="https://codepen.io/hypersphere">@hypersphere</a>)
  on <a href="https://codepen.io">CodePen</a>.</span>
</p>
<script async src="https://cpwebassets.codepen.io/assets/embed/ei.js"></script>
<h2 id="post-processing" tabindex="-1">Post Processing <a class="header-anchor" href="#post-processing">#</a></h2>
<p>Post-processing was an important step in making my game look more realistically retro. The old CRT created very unique artifacts when displaying color images due to the architecture of the display.</p>
<img alt="Photo by ryuuji89 from Please show off what crt shaders can do!" loading="lazy" decoding="async" style="aspect-ratio: 1.356" width="678" height="500" src="/img/kUgpRapiGM-678.webp">
<p>In my attempt to emulate old retro style I overlayed a variation of <a href="https://en.wikipedia.org/wiki/Bayer_filter">Bayers Filter</a> with a slight blur on top of every game pixel and blended it using color-burn blend mode. This made the game have its original style. It, unfortunately, made it way darker but with the main theme around death, it seemed appropriate.</p>
<img alt="Postprocessing" loading="lazy" decoding="async" style="aspect-ratio: 1.4613636363636364" width="2572" height="1760" src="/img/4wHe5u0V2n-2572.webp">
<p>Here‚Äôs the snippet of the code responsible for the effect:</p>
<pre class="language-ts" tabindex="0"><code class="language-ts"><span class="token comment">// drawing on posteffect canvas if it was not done before with slight blur between color "pixels"</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>postCanvas<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>postCanvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> m <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>game<span class="token punctuation">.</span><span class="token constant">MULTIPLIER</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>postCanvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postCanvas<span class="token punctuation">.</span>height <span class="token operator">=</span> m<span class="token punctuation">;</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>postCanvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>filter <span class="token operator">=</span> <span class="token string">'blur(1px)'</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">"red"</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>m<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  m <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> m<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">"green"</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> m<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span>m<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> m<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> m<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> m<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>pattern <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">createPattern</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>postCanvas<span class="token punctuation">,</span> <span class="token string">"repeat"</span><span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>


<span class="token comment">// blending it using color-burn</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> <span class="token number">0.6</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>globalCompositeOperation <span class="token operator">=</span> <span class="token string">"color-burn"</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pattern<span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">fillRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>width<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// reverting original blend mode.</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>globalCompositeOperation <span class="token operator">=</span> <span class="token string">"source-over"</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></code></pre>
<h2 id="audio" tabindex="-1">Audio <a class="header-anchor" href="#audio">#</a></h2>
<p>To generate music I‚Äôve used WebAudio API which provides node-based architecture you can use to combine oscillators, filters, effects, and other audio nodes together.</p>
<img alt="Web Audio" loading="lazy" decoding="async" style="aspect-ratio: 2.08955223880597" width="1400" height="670" src="/img/cfqeE-TQyT-1400.webp">
<p>I have <a href="https://github.com/h-sphere/gravepassing/blob/main/src/modules/Audio/AudioTrack.ts">implemented a simple audio tracker</a> that reads predefined music scores and schedules audio. The track can be defined as a string of MIDI notes, encoded as UTF-8 characters:</p>
<img alt="UTF-8 to MIDI converter" loading="lazy" decoding="async" style="aspect-ratio: 1.6614620298083747" width="2341" height="1409" src="/img/4I8waPiEJJ-2341.webp">
<p>A song consists of multiple tracks. They share the same BPM but can have different time divisions defined making it quite easy to iterate on music ideas.</p>
<p>If you want to learn more about how to use Web Audio, I highly recommend my article about the subject:</p>
<p><a href="https://medium.com/swinginc/playing-with-midi-in-javascript-b6999f2913c3">Playing with MIDI in JavaScript</a></p>
<p>and if you want to learn more about MIDI and how to use it in your browser, I recommend the introductory article to my MIDI library written in TypeScript:</p>
<p><a href="https://kulak.medium.com/introducing-midival-f837b2d48185">Introducing MIDIVal: the easiest way to interact with MIDI in your browser</a></p>
<h2 id="optimizing-package-size" tabindex="-1">Optimizing package size <a class="header-anchor" href="#optimizing-package-size">#</a></h2>
<p>Once the game is done, it‚Äôs time for compression. My main goal was not to constrain myself when writing code, to be able to use object-oriented programming with proper class names, and defer the minification to a separate step. Thanks to that majority of the code stayed readable (I only had to manually change a handful of things) and still minifies well.</p>
<p>The limit is exactly 13312b (13 * 1024) and my package without compression was initially around 14500b. That‚Äôs 1.5kb of compressed code to shave.</p>
<p>I‚Äôve started by incorporating uglify in the build flow which mostly removed some console.logs and shorten some names. I played a bit with parameters but it didn‚Äôt do a great job of replacing the names of my classes and methods. I decided to go with a custom solution.</p>
<h2 id="codemod-for-typescript" tabindex="-1">Codemod for TypeScript <a class="header-anchor" href="#codemod-for-typescript">#</a></h2>
<p>Fortunately, the whole codebase was written in TypeScript. Thanks to that I could easily rename the majority of the class names, properties, and functions using a simple codemod written with the help of ts-morph.</p>
<p><a href="https://ts-morph.com/">TS-morph</a> is a simple tool helping with navigating the TypeScript AST tree. Instead of having to manually navigate through the nodes, you can easily extract all the symbols from the file and change them in all places automatically.</p>
<pre class="language-ts" tabindex="0"><code class="language-ts"><span class="token keyword">let</span> name <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">generateNextName</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">90</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
    name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">65</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  name<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">nameString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

classes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>i <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> i<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nextName <span class="token operator">=</span> <span class="token function">generateNextName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>name <span class="token operator">===</span> nextName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Rename class</span>
    <span class="token class-name"><span class="token builtin">console</span></span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'->'</span><span class="token punctuation">,</span> nextName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    i<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>nextName<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      renameInComments<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      renameInStrings<span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>The code above renames all class names into <code>AA</code> , <code>AB</code> , <code>AC</code> and so on. Because we use typed language, we know where the class is used so all usages are automatically renamed as well. The same was done to class methods and properties. <a href="https://github.com/h-sphere/gravepassing/blob/main/scripts/rename-classes.ts">Here‚Äôs my full codemod</a>.</p>
<h3 id="roadroller" tabindex="-1">Roadroller <a class="header-anchor" href="#roadroller">#</a></h3>
<p>To reduce the size even further I used <a href="https://lifthrasiir.github.io/roadroller/">roadroller</a>. It is a tool that flattens JavaScript by using complex compression techniques like bytewise rANS coder, making the source code completely unreadable but very efficient. It shaved a few kb of my code making my bundle fit the limit with no problem.</p>
<p>What do you think of the solutions? What would you add or improve in my entry? Put your thoughts down in the comments!</p>

<ul class="links-nextprev"><li>Next: <a href="/blog/randomness-in-css-using-trigonometry/">Randomness in CSS using trigonometry</a></li>
</ul>

</section>
		</main>

		<footer></footer>

		<!-- Current page: /blog/gameboy-like-app-in-13k/ -->
	</body>
</html>
